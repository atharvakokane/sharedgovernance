<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <title>VT Shared Governance Tracker - Admin</title>
  <link rel="stylesheet" href="css/styles.css?v=20260227">
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <h1>VT Shared Governance Tracker</h1>
      <div class="header-actions">
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">â˜°</button>
        <nav class="nav-main" id="navMain">
          <span style="color: rgba(255,255,255,0.9); padding: 0.5rem 0.75rem; font-size: 0.9rem;">Admin</span>
          <button type="button" class="btn btn-logout" id="logoutBtn">Logout</button>
        </nav>
      </div>
    </header>

    <main class="main-content">
      <div class="card">
        <h2 class="card-title">Cabinet Control Center</h2>
        <p style="margin: 0 0 1rem 0; color: var(--color-text-muted);">
          View submissions, manage committee assignments, and edit meetings.
        </p>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
          <button type="button" class="btn btn-secondary" id="exportJsonBtn">Export JSON</button>
          <label class="btn btn-secondary" style="margin: 0; cursor: pointer;">
            Import
            <input type="file" id="importFile" accept=".json" style="display: none;">
          </label>
          <button type="button" class="btn btn-danger btn-sm" id="resetDataBtn" title="Clear locally cached data and reload from files">Reset Cached Data</button>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">Submissions</h2>
        <p style="margin: 0 0 1rem 0; color: var(--color-text-muted); font-size: 0.9rem;">
          All meeting notes and attendance confirmations from senators.
        </p>
        <div id="submissionsSection">
          <p class="empty-state">Loading...</p>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">Committee Assignments</h2>
        <p style="margin: 0 0 1rem 0; color: var(--color-text-muted); font-size: 0.9rem;">
          Reassign senators to committees. Select a senator and committee, then Add or Remove.
        </p>
        <div id="assignmentsSection">
          <p class="empty-state">Loading...</p>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">Meeting Calendar</h2>
        <p style="margin: 0 0 1rem 0; color: var(--color-text-muted); font-size: 0.9rem;">
          Cabinet view of all scheduled meetings. Colors indicate committee.
        </p>
        <div id="adminCalendarSection">
          <p class="empty-state">Loading...</p>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">Meetings</h2>
        <p style="margin: 0 0 1rem 0; color: var(--color-text-muted); font-size: 0.9rem;">
          Edit meeting details, add new meetings, or remove outdated ones.
        </p>
        <div id="meetingsSection">
          <p class="empty-state">Loading...</p>
        </div>
      </div>
    </main>
  </div>

  <script src="js/utils.js?v=20260227"></script>
  <script src="js/auth.js?v=20260227"></script>
  <script src="js/admin.js?v=20260227"></script>
  <script>
    (function() {
      // Always attach UI handlers first so logout always works
      document.getElementById('menuToggle').addEventListener('click', function() {
        document.getElementById('navMain').classList.toggle('open');
      });
      document.getElementById('logoutBtn').addEventListener('click', function() {
        clearSession();
        redirectToLogin();
      });

      // Export button
      document.getElementById('exportJsonBtn').addEventListener('click', exportSubmissionsJSON);

      // Import button
      document.getElementById('importFile').addEventListener('change', function(e) {
        var file = e.target.files && e.target.files[0];
        if (file) {
          importSubmissions(file, function() { renderSubmissionsTable(getSubmissions()); });
          e.target.value = '';
        }
      });

      // Reset cached data button
      document.getElementById('resetDataBtn').addEventListener('click', function() {
        localStorage.removeItem(GOV_STORAGE_KEYS.MEETINGS_OVERRIDE);
        localStorage.removeItem(GOV_STORAGE_KEYS.ASSIGNMENTS_OVERRIDE);
        window.location.reload();
      });

      // Session check - redirect to login if not authenticated
      var session = requireAuth('admin');
      if (!session) return;

      // Render submissions immediately (from localStorage, no fetch needed)
      renderSubmissionsTable(getSubmissions());

      // Load assignments and meetings data
      Promise.all([
        fetchData('meetings.json'),
        fetchData('assignments.json'),
        fetchData('committees.json').catch(function() { return []; })
      ]).then(function(results) {
        var meetings = getMeetingsWithOverride(results[0]);
        var assignments = getAssignmentsWithOverride(results[1]);
        var allowedCommittees = Array.isArray(results[2]) ? results[2] : [];

        try {
          renderAssignmentsSection(assignments, meetings, allowedCommittees);
        } catch (e) {
          console.error('Assignments render error:', e);
          document.getElementById('assignmentsSection').innerHTML = '<div class="alert alert-info">Error: ' + e.message + '</div>';
        }
        try {
          renderMeetingsCalendar('adminCalendarSection', meetings, {
            emptyMessage: 'No meetings scheduled.'
          });
          renderMeetingsSection(meetings, allowedCommittees, function(updatedMeetings) {
            renderMeetingsCalendar('adminCalendarSection', updatedMeetings, {
              emptyMessage: 'No meetings scheduled.'
            });
          });
        } catch (e) {
          console.error('Meetings render error:', e);
          document.getElementById('adminCalendarSection').innerHTML = '<div class="alert alert-info">Error: ' + e.message + '</div>';
          document.getElementById('meetingsSection').innerHTML = '<div class="alert alert-info">Error: ' + e.message + '</div>';
        }
      }).catch(function(e) {
        document.getElementById('assignmentsSection').innerHTML = '<div class="alert alert-info">Unable to load data. Refresh to retry.</div>';
        document.getElementById('adminCalendarSection').innerHTML = '<div class="alert alert-info">Unable to load data. Refresh to retry.</div>';
        document.getElementById('meetingsSection').innerHTML = '<div class="alert alert-info">Unable to load data. Refresh to retry.</div>';
      });
    })();
  </script>
</body>
</html>
